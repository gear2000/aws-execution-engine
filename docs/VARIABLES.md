# Variables Reference

Complete reference for `job_parameters_b64` — the base64-encoded payload sent to the `process_webhook` Lambda.

---

## Global (Job-Level)

| Variable | Required | Notes |
|---|---|---|
| `git_repo` | YES | Repo where PR/issue lives |
| `pr_number` | YES * | PR to post comments on |
| `issue_number` | YES * | * One of `pr_number` or `issue_number` required |
| `git_token_location` | YES | `aws:::ssm:<path>` or `aws:::secretd:<path>` |
| `git_ssh_key_location` | NO | Alternative to token for SSH clone (same path format) |
| `username` | YES | Used in flow_id generation; or derived from git identity |
| `flow_label` | NO | Suffix for flow_id. Defaults to `"exec"` |
| `pr_comment_search_tag` | NO | Auto-generated if not provided |
| `presign_expiry` | NO | Presigned URL expiry in seconds. Default: 7200 (2 hours) |
| `job_timeout` | NO | Timeout for the entire job (all orders). Default: 3600 |

---

## Per Order

| Variable | Required | Notes |
|---|---|---|
| `cmds` | YES | List of shell commands, pre-resolved by upstream |
| `timeout` | YES | Per-order timeout in seconds |
| `order_name` | NO | Derived from folder/cmd if not provided |
| `git_repo` | NO | Defaults to global `git_repo` |
| `git_folder` | NO | Subfolder within repo to use as working directory |
| `s3_location` | NO | S3 zip of execution files (alternative to git) |
| `env_vars` | NO | Dict of extra environment variables |
| `ssm_paths` | NO | List of AWS SSM Parameter Store paths to fetch |
| `secret_manager_paths` | NO | List of AWS Secrets Manager paths to fetch |
| `sops_key` | NO | SOPS encryption key. Auto-generated temp key if not provided |
| `use_lambda` | NO | `true` = Lambda execution (faster, 10 min limit). `false` = CodeBuild. Default: `false` |
| `queue_id` | NO | Auto-generated if not provided. Used for dependency references |
| `dependencies` | NO | List of `queue_id` values this order depends on |
| `must_succeed` | NO | If `true` (default), failure of this order fails the entire job |

---

## Example Payload

```json
{
  "git_repo": "org/infra-repo",
  "pr_number": 42,
  "git_token_location": "aws:::ssm:/iac-ci/github-token",
  "username": "gear",
  "flow_label": "plan",
  "orders": [
    {
      "order_name": "deploy-vpc",
      "cmds": ["tofu init", "tofu plan -out=plan.out"],
      "timeout": 300,
      "git_folder": "terraform/vpc",
      "env_vars": {"TF_VAR_env": "staging"},
      "ssm_paths": ["/infra/staging/db-password"],
      "use_lambda": true,
      "queue_id": "vpc-plan"
    },
    {
      "order_name": "deploy-rds",
      "cmds": ["tofu init", "tofu plan -out=plan.out"],
      "timeout": 300,
      "git_folder": "terraform/rds",
      "secret_manager_paths": ["infra/staging/rds-creds"],
      "use_lambda": true,
      "queue_id": "rds-plan",
      "dependencies": ["vpc-plan"]
    },
    {
      "order_name": "run-migrations",
      "cmds": ["./scripts/migrate.sh"],
      "timeout": 600,
      "s3_location": "s3://deploy-artifacts/migrations/v2.3.zip",
      "use_lambda": false,
      "dependencies": ["rds-plan"],
      "must_succeed": false
    }
  ]
}
```

This payload is base64-encoded before being sent to the `process_webhook` Lambda.

---

## Auto-Generated Values

The following are generated by the system if not provided in the payload:

| Value | Generation |
|---|---|
| `trace_id` | Random hex string (e.g. `a3f7b2c1`) |
| `run_id` | UUID |
| `flow_id` | `<username>:<trace_id>-<flow_label>` |
| `done_endpt` | `s3://<done-bucket>/<run_id>/done` |
| `pr_comment_search_tag` | Random string |
| `queue_id` (per order) | Auto-incremented or UUID |
| `sops_key` (per order) | Temporary KMS key or age key |
| `order_name` (per order) | Derived from `git_folder` or first cmd |

---

## Callback URL (Internal)

Generated during repackage (Part 1, Step 2) for each order:

```
Presigned S3 PUT URL pointing to:
  s3://<internal-bucket>/tmp/callbacks/runs/<run_id>/<order_num>/result.json

Baked into SOPS bundle as CALLBACK_URL env var.
Also stored in orders DynamoDB table as callback_url field.
Expiry: presign_expiry (default 2 hours).
```

---

## Done Endpoint (External)

Written by orchestrator when all orders complete:

```
s3://<done-bucket>/<run_id>/done

Content:
{
  "status": "succeeded/failed/timed_out",
  "summary": {
    "succeeded": 3,
    "failed": 1,
    "timed_out": 0
  }
}
```

Separate S3 bucket from internal — no access to order data.
